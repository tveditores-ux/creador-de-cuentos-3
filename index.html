<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>GracePrint Studio | Edici√≥n Calma</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Patrick+Hand&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        /* --- EST√âTICA PAS & COLORFUL --- */
        :root {
            --bg-body: #fdfbf7;      /* Crema muy suave */
            --card-bg: #ffffff;
            --text-main: #5e6c84;    /* Gris azulado (no negro puro) */
            --primary: #9b99ff;      /* Lavanda suave */
            --secondary: #94d3ac;    /* Menta calmante */
            --accent: #ffb7b2;       /* Melocot√≥n c√°lido */
            --shadow: 0 10px 30px rgba(154, 160, 185, 0.15);
            --radius: 24px;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
            background-image: radial-gradient(#e0e7ff 1px, transparent 1px);
            background-size: 20px 20px; /* Patr√≥n de puntos sutil */
        }

        .container {
            max-width: 950px;
            margin: auto;
            background: var(--card-bg);
            padding: 50px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid white;
        }

        /* T√≠tulos */
        h1 {
            text-align: center;
            color: #6c5ce7; /* Violeta suave */
            font-size: 2.5rem;
            margin-bottom: 10px;
            letter-spacing: -1px;
        }

        .subtitle {
            text-align: center;
            color: #a29bfe;
            margin-bottom: 40px;
            font-weight: 600;
        }

        /* Layout */
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }

        /* Tarjetas de Input */
        .panel {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 18px;
            border: 2px dashed #e2e8f0;
            transition: all 0.3s ease;
        }

        .panel:hover {
            border-color: var(--primary);
            background: #fff;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        label {
            display: block;
            font-weight: 700;
            margin-bottom: 12px;
            color: #636e72;
            font-size: 1.1rem;
        }

        /* Inputs estilizados */
        input[type="file"]::file-selector-button {
            border: none;
            padding: 8px 15px;
            border-radius: 12px;
            background-color: var(--primary);
            color: white;
            cursor: pointer;
            font-family: 'Nunito';
            font-weight: bold;
            margin-right: 10px;
            transition: background 0.2s;
        }
        input[type="file"]::file-selector-button:hover { background-color: #7c7af0; }

        textarea {
            width: 100%;
            height: 160px;
            padding: 15px;
            border-radius: 15px;
            border: 2px solid #e2e8f0;
            font-family: 'Patrick Hand', cursive; /* Fuente l√∫dica para escribir */
            font-size: 20px;
            color: #2d3436;
            box-sizing: border-box;
            background-color: #fff;
            resize: none;
            outline: none;
            transition: border 0.3s;
        }

        textarea:focus { border-color: var(--secondary); }
        textarea::placeholder { color: #b2bec3; }

        /* Botones "Gomitas" */
        .actions {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 40px;
        }

        button {
            padding: 18px;
            border: none;
            border-radius: 16px;
            font-weight: 800;
            font-size: 1.1rem;
            cursor: pointer;
            color: white;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        button:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        button:active { transform: scale(0.96); }

        .btn-gen { background: linear-gradient(135deg, #a29bfe, #6c5ce7); }
        .btn-pdf { background: linear-gradient(135deg, #ffb7b2, #ff7675); }
        .btn-epub { background: linear-gradient(135deg, #81ecec, #00cec9); color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        /* √Årea de Preview tipo "Estanter√≠a" */
        #preview {
            margin-top: 50px;
            background: #dfe6e9;
            padding: 30px;
            border-radius: 20px;
            display: flex;
            gap: 20px;
            overflow-x: auto;
            white-space: nowrap;
            /* Scrollbar bonita */
            scrollbar-width: thin;
            scrollbar-color: var(--primary) #dfe6e9;
            border-bottom: 6px solid #b2bec3; /* Efecto estanter√≠a */
        }

        #preview img {
            height: 240px;
            border-radius: 5px;
            box-shadow: 3px 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s;
            background: white;
        }

        #preview img:hover { transform: scale(1.05) rotate(-2deg); z-index: 10; }
        
        /* Mensaje vac√≠o */
        .empty-state { text-align: center; width: 100%; color: #636e72; padding: 20px; }

    </style>
</head>
<body>

<div class="container">
    <h1>üé® GracePrint Studio</h1>
    <p class="subtitle">Crea cuentos m√°gicos con calma y belleza</p>
    
    <div class="grid">
        <div class="panel">
            <label>üìö 1. Tus Ilustraciones</label>
            <p style="font-size:0.9em; margin-top:-5px; color:#888; margin-bottom:10px;">La primera es la Portada, la √∫ltima es el Final.</p>
            <input type="file" id="images" multiple accept="image/*">
            
            <label style="margin-top:20px;">üñºÔ∏è 2. Papel Decorativo</label>
            <p style="font-size:0.9em; margin-top:-5px; color:#888; margin-bottom:10px;">El fondo para las p√°ginas de texto.</p>
            <input type="file" id="template" accept="image/*">
        </div>
        <div class="panel">
            <label>‚úçÔ∏è 3. La Historia</label>
            <textarea id="storyText" placeholder="Hab√≠a una vez en un bosque de colores suaves...&#10;&#10;(Escribe un p√°rrafo por cada p√°gina interior)"></textarea>
        </div>
    </div>

    <div class="actions">
        <button class="btn-gen" onclick="generar()">‚ú® Crear Magia</button>
        <button class="btn-pdf" onclick="exportarPDF()">üìÑ Guardar PDF</button>
        <button class="btn-epub" onclick="exportarEPUB()">üì± Guardar eBook</button>
    </div>

    <div id="preview">
        <div class="empty-state">Aqu√≠ aparecer√°n tus p√°ginas como una peque√±a biblioteca...</div>
    </div>
</div>

<script>
/* --- L√ìGICA ROBUSTA (Misma funcionalidad, nueva est√©tica) --- */
let paginasData = [];

async function generar() {
    const imgFiles = document.getElementById('images').files;
    const tplFile = document.getElementById('template').files[0];
    const parrafos = document.getElementById('storyText').value.split('\n').filter(p => p.trim() !== "");
    const preview = document.getElementById('preview');

    if (imgFiles.length < 2) return alert("¬°Ups! Necesitas al menos 2 im√°genes (Portada y Contraportada) para empezar.");
    
    paginasData = [];
    preview.innerHTML = ""; // Limpiar
    
    const tplImg = tplFile ? await loadImg(tplFile) : null;
    const btnGen = document.querySelector('.btn-gen');
    btnGen.textContent = "‚è≥ Pintando...";

    for (let i = 0; i < imgFiles.length; i++) {
        const currentImg = await loadImg(imgFiles[i]);
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const h = 1400; 

        const esPortada = (i === 0);
        const esContra = (i === imgFiles.length - 1);

        if (esPortada || esContra) {
            // Hoja Viuda
            canvas.width = (currentImg.width * h) / currentImg.height;
            canvas.height = h;
            ctx.drawImage(currentImg, 0, 0, canvas.width, h);
        } else {
            // Hoja Interior
            const lw = (currentImg.width * h) / currentImg.height;
            const rw = tplImg ? (tplImg.width * h) / tplImg.height : 800;
            
            canvas.width = lw + rw;
            canvas.height = h;

            ctx.drawImage(currentImg, 0, 0, lw, h);
            if (tplImg) {
                ctx.drawImage(tplImg, lw, 0, rw, h);
            } else {
                ctx.fillStyle = "#fff"; ctx.fillRect(lw,0,rw,h);
            }

            const texto = parrafos[i - 1] || "";
            if (texto) {
                const mx = lw + (rw * 0.12);
                // Azul oscuro suave para texto
                ctx.fillStyle = "#2d3436"; 
                ctx.font = "bold 180px 'Patrick Hand', cursive";
                const cap = texto.charAt(0).toUpperCase();
                const capW = ctx.measureText(cap).width + 30;
                
                // Letra capital en color Accent (Melocot√≥n oscuro)
                ctx.fillStyle = "#e17055"; 
                ctx.fillText(cap, mx, 350);
                
                ctx.fillStyle = "#2d3436";
                ctx.font = "60px 'Patrick Hand', cursive";
                wrapText(ctx, texto.slice(1), mx, 280, rw * 0.76, 75, capW, 2);
            }
        }
        
        paginasData.push({ url: canvas.toDataURL('image/jpeg', 0.85), w: canvas.width, h: canvas.height });
        
        const pImg = document.createElement('img');
        pImg.src = paginasData[i].url;
        preview.appendChild(pImg);
    }
    btnGen.textContent = "‚ú® Crear Magia";
}

function wrapText(ctx, text, x, y, maxWidth, lineHeight, gapWidth, linesWithGap) {
    const words = text.split(' ');
    let line = ''; let curL = 1; let curY = y;
    for (let n = 0; n < words.length; n++) {
        let test = line + words[n] + ' ';
        let cx = (curL <= linesWithGap) ? (x + gapWidth) : x;
        let cw = (curL <= linesWithGap) ? (maxWidth - gapWidth) : maxWidth;
        if (ctx.measureText(test).width > cw && n > 0) {
            ctx.fillText(line, cx, curY);
            line = words[n] + ' '; curY += lineHeight; curL++;
        } else { line = test; }
    }
    ctx.fillText(line, (curL <= linesWithGap ? x + gapWidth : x), curY);
}

function loadImg(f) { return new Promise(res => { const i = new Image(); i.onload = () => res(i); i.src = URL.createObjectURL(f); }); }

function exportarPDF() {
    if(!paginasData.length) return alert("Primero crea la magia ‚ú®");
    const pdf = new jspdf.jsPDF({ orientation: 'landscape', unit: 'px' });
    paginasData.forEach((p, i) => {
        if (i > 0) pdf.addPage([p.w, p.h], p.w > p.h ? 'l' : 'p');
        else { pdf.deletePage(1); pdf.addPage([p.w, p.h], p.w > p.h ? 'l' : 'p'); }
        pdf.addImage(p.url, 'JPEG', 0, 0, p.w, p.h);
    });
    pdf.save("Cuento_Magico.pdf");
}

async function exportarEPUB() {
    if (!paginasData.length) return alert("Primero crea la magia ‚ú®");

    const zip = new JSZip();
    const uniqueId = `urn:uuid:gp-${Date.now()}`;
    zip.file("mimetype", "application/epub+zip", { compression: "STORE" }); // Cr√≠tico

    const metaInf = zip.folder("META-INF");
    metaInf.file("container.xml", `<?xml version="1.0"?><container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container"><rootfiles><rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/></rootfiles></container>`);

    const oebps = zip.folder("OEBPS");
    const images = oebps.folder("images");

    let manifestItems = "";
    let spineItems = "";
    let ncxNavMap = "";

    for (let i = 0; i < paginasData.length; i++) {
        const p = paginasData[i];
        images.file(`img${i}.jpg`, p.url.split(',')[1], {base64: true});

        const xhtmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head><title>P${i}</title><meta name="viewport" content="width=${p.w}, height=${p.h}"/><style>body{margin:0;background:#2d3436;text-align:center;}img{height:100%;}</style></head>
<body><img src="images/img${i}.jpg"/></body></html>`;
        
        oebps.file(`page${i}.xhtml`, xhtmlContent);
        
        manifestItems += `<item id="img${i}" href="images/img${i}.jpg" media-type="image/jpeg" ${i===0?'properties="cover-image"':''}/>\n`;
        manifestItems += `<item id="page${i}" href="page${i}.xhtml" media-type="application/xhtml+xml"/>\n`;
        
        let spread = (i===0 || i===paginasData.length-1) ? 'page-spread-center' : (i%2!==0 ? 'page-spread-left' : 'page-spread-right');
        spineItems += `<itemref idref="page${i}" properties="${spread}"/>\n`;
        ncxNavMap += `<navPoint id="np${i}" playOrder="${i+1}"><navLabel><text>P${i+1}</text></navLabel><content src="page${i}.xhtml"/></navPoint>`;
    }

    const ncx = `<?xml version="1.0" encoding="UTF-8"?><ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1"><head><meta name="dtb:uid" content="${uniqueId}"/></head><docTitle><text>Cuento</text></docTitle><navMap>${ncxNavMap}</navMap></ncx>`;
    oebps.file("toc.ncx", ncx);

    const opf = `<?xml version="1.0" encoding="UTF-8"?>
<package xmlns="http://www.idpf.org/2007/opf" unique-identifier="uid" version="3.0">
<metadata xmlns:dc="http://purl.org/dc/elements/1.1/"><dc:identifier id="uid">${uniqueId}</dc:identifier><dc:title>Mi Cuento</dc:title><dc:language>es</dc:language><meta property="rendition:layout">pre-paginated</meta><meta property="rendition:spread">auto</meta></metadata>
<manifest><item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>${manifestItems}</manifest>
<spine toc="ncx">${spineItems}</spine></package>`;
    
    oebps.file("content.opf", opf);
    
    const content = await zip.generateAsync({type:"blob"});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(content);
    link.download = "Libro_Magico.epub";
    link.click();
}
</script>
</body>
</html>
