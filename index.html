<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>GracePrint Studio - Edici√≥n Final</title>
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --primary: #4a6cf7; --epub: #059669; --accent: #dc2626; }
        body { font-family: 'Segoe UI', sans-serif; background: #e2e8f0; margin: 0; padding: 20px; }
        .container { max-width: 950px; margin: auto; background: white; padding: 35px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #1e293b; margin-bottom: 5px; }
        .subtitle { text-align: center; color: #64748b; font-size: 0.9em; margin-bottom: 30px; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .panel { background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #cbd5e1; }
        
        label { display: block; font-weight: bold; margin-bottom: 8px; color: #334155; }
        input[type="file"] { width: 100%; margin-bottom: 15px; }
        
        textarea { 
            width: 100%; height: 140px; padding: 12px; border-radius: 8px; border: 1px solid #94a3b8; 
            font-family: 'Patrick Hand', cursive; font-size: 18px; resize: none; 
        }

        .actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 25px; }
        button { padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; font-size: 15px; transition: 0.2s; }
        button:hover { opacity: 0.95; transform: translateY(-1px); }
        
        .btn-gen { background: var(--primary); }
        .btn-pdf { background: var(--accent); }
        .btn-epub { background: var(--epub); }

        #preview { margin-top: 40px; background: #cbd5e1; padding: 20px; border-radius: 10px; display: flex; gap: 15px; overflow-x: auto; white-space: nowrap; }
        #preview img { height: 220px; border: 4px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.2); display: inline-block; }
    </style>
</head>
<body>

<div class="container">
    <h1>üìö GracePrint Studio</h1>
    <p class="subtitle">Creador de Libros Ilustrados (Fixed Layout)</p>
    
    <div class="grid">
        <div class="panel">
            <label>1. Im√°genes (Orden: Portada ... Contra)</label>
            <input type="file" id="images" multiple accept="image/*">
            <label>2. Fondo para p√°ginas interiores</label>
            <input type="file" id="template" accept="image/*">
        </div>
        <div class="panel">
            <label>3. Historia (Un p√°rrafo por hoja interior)</label>
            <textarea id="storyText" placeholder="Erase una vez en un bosque...&#10;El drag√≥n vol√≥ alto..."></textarea>
        </div>
    </div>

    <div class="actions">
        <button class="btn-gen" onclick="generar()">‚ú® 1. Generar</button>
        <button class="btn-pdf" onclick="exportarPDF()">üìÑ 2. PDF</button>
        <button class="btn-epub" onclick="exportarEPUB()">üìñ 3. ePUB (Corregido)</button>
    </div>

    <div id="preview"></div>
</div>

<script>
let paginasData = [];

async function generar() {
    const imgFiles = document.getElementById('images').files;
    const tplFile = document.getElementById('template').files[0];
    const parrafos = document.getElementById('storyText').value.split('\n').filter(p => p.trim() !== "");
    const preview = document.getElementById('preview');

    if (imgFiles.length < 2) return alert("Sube al menos 2 im√°genes (Portada y Contraportada).");
    
    paginasData = [];
    preview.innerHTML = "";
    
    // Cargar fondo si existe
    const tplImg = tplFile ? await loadImg(tplFile) : null;

    for (let i = 0; i < imgFiles.length; i++) {
        const currentImg = await loadImg(imgFiles[i]);
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const h = 1400; // Resoluci√≥n equilibrada

        const esPortada = (i === 0);
        const esContra = (i === imgFiles.length - 1);

        if (esPortada || esContra) {
            // -- P√ÅGINA VIUDA (Solo Imagen) --
            // Mantiene la relaci√≥n de aspecto original de la imagen subida
            canvas.width = (currentImg.width * h) / currentImg.height;
            canvas.height = h;
            ctx.drawImage(currentImg, 0, 0, canvas.width, h);
        } else {
            // -- P√ÅGINA INTERIOR (Imagen + Texto) --
            const lw = (currentImg.width * h) / currentImg.height;
            // Si hay fondo usa su proporci√≥n, si no, usa un ancho est√°ndar
            const rw = tplImg ? (tplImg.width * h) / tplImg.height : 800;
            
            canvas.width = lw + rw;
            canvas.height = h;

            ctx.drawImage(currentImg, 0, 0, lw, h);
            if (tplImg) {
                ctx.drawImage(tplImg, lw, 0, rw, h);
            } else {
                ctx.fillStyle = "#fff"; ctx.fillRect(lw,0,rw,h); // Fondo blanco si falta img
            }

            // Texto
            const texto = parrafos[i - 1] || "";
            if (texto) {
                const mx = lw + (rw * 0.12);
                ctx.fillStyle = "#1e3a8a"; 
                ctx.font = "bold 180px 'Patrick Hand', cursive";
                const cap = texto.charAt(0).toUpperCase();
                const capW = ctx.measureText(cap).width + 30;
                ctx.fillText(cap, mx, 350);
                
                ctx.fillStyle = "#334155";
                ctx.font = "60px 'Patrick Hand', cursive";
                wrapText(ctx, texto.slice(1), mx, 280, rw * 0.76, 75, capW, 2);
            }
        }
        
        // Guardamos calidad 0.85 para buen balance peso/calidad
        paginasData.push({ url: canvas.toDataURL('image/jpeg', 0.85), w: canvas.width, h: canvas.height });
        
        const pImg = document.createElement('img');
        pImg.src = paginasData[i].url;
        preview.appendChild(pImg);
    }
}

function wrapText(ctx, text, x, y, maxWidth, lineHeight, gapWidth, linesWithGap) {
    const words = text.split(' ');
    let line = ''; let curL = 1; let curY = y;
    for (let n = 0; n < words.length; n++) {
        let test = line + words[n] + ' ';
        let cx = (curL <= linesWithGap) ? (x + gapWidth) : x;
        let cw = (curL <= linesWithGap) ? (maxWidth - gapWidth) : maxWidth;
        if (ctx.measureText(test).width > cw && n > 0) {
            ctx.fillText(line, cx, curY);
            line = words[n] + ' '; curY += lineHeight; curL++;
        } else { line = test; }
    }
    ctx.fillText(line, (curL <= linesWithGap ? x + gapWidth : x), curY);
}

function loadImg(f) { return new Promise(res => { const i = new Image(); i.onload = () => res(i); i.src = URL.createObjectURL(f); }); }

function exportarPDF() {
    if(!paginasData.length) return alert("Genera primero.");
    const pdf = new jspdf.jsPDF({ orientation: 'landscape', unit: 'px' });
    paginasData.forEach((p, i) => {
        if (i > 0) pdf.addPage([p.w, p.h], p.w > p.h ? 'l' : 'p');
        else { pdf.deletePage(1); pdf.addPage([p.w, p.h], p.w > p.h ? 'l' : 'p'); }
        pdf.addImage(p.url, 'JPEG', 0, 0, p.w, p.h);
    });
    pdf.save("Libro_GracePrint.pdf");
}

async function exportarEPUB() {
    if (paginasData.length === 0) return alert("Genera el libro primero.");

    const zip = new JSZip();
    const timestamp = Date.now();
    const uniqueId = `urn:uuid:graceprint-${timestamp}`;

    // 1. MIMETYPE: SIN COMPRESI√ìN (CR√çTICO PARA QUE NO DE ERROR DE DA√ëADO)
    zip.file("mimetype", "application/epub+zip", { compression: "STORE" });

    // 2. CONTENEDOR (Container.xml)
    const metaInf = zip.folder("META-INF");
    metaInf.file("container.xml", `<?xml version="1.0" encoding="UTF-8" ?>
<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
  <rootfiles>
    <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>
  </rootfiles>
</container>`.trim());

    // 3. CARPETA DE CONTENIDO
    const oebps = zip.folder("OEBPS");
    const images = oebps.folder("images");

    let manifestItems = "";
    let spineItems = "";
    let ncxNavMap = ""; // Para el archivo de compatibilidad NCX

    for (let i = 0; i < paginasData.length; i++) {
        const p = paginasData[i];
        const imgFilename = `img${i}.jpg`;
        const xhtmlFilename = `page${i}.xhtml`;

        // Guardar Imagen
        images.file(imgFilename, p.url.split(',')[1], {base64: true});

        // Crear XHTML
        const xhtmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
  <title>P√°gina ${i+1}</title>
  <meta name="viewport" content="width=${p.w}, height=${p.h}"/>
  <style>
    body { margin: 0; padding: 0; background-color: #333; text-align: center; }
    img { width: 100%; height: 100%; object-fit: contain; }
  </style>
</head>
<body>
  <img src="images/${imgFilename}" alt="Pagina ${i+1}" />
</body>
</html>`;
        oebps.file(xhtmlFilename, xhtmlContent.trim());

        // Manifest
        const props = (i===0) ? ' properties="cover-image"' : '';
        manifestItems += `<item id="img${i}" href="images/${imgFilename}" media-type="image/jpeg"${props}/>\n`;
        manifestItems += `<item id="page${i}" href="${xhtmlFilename}" media-type="application/xhtml+xml"/>\n`;

        // Spine (Spread Logic)
        // Portada y Contraportada = Center (o none). Interiores = alternar.
        let spreadProp = "";
        if (i === 0 || i === paginasData.length - 1) {
            spreadProp = ' properties="page-spread-center"';
        } else {
            // i=1 (Interior 1) -> izquierda, i=2 (Interior 2) -> derecha...
            // Ajustamos seg√∫n paridad.
            spreadProp = (i % 2 !== 0) ? ' properties="page-spread-left"' : ' properties="page-spread-right"';
        }
        spineItems += `<itemref idref="page${i}"${spreadProp}/>\n`;

        // NCX Map (Para compatibilidad antigua)
        ncxNavMap += `<navPoint id="navPoint-${i+1}" playOrder="${i+1}"><navLabel><text>P√°gina ${i+1}</text></navLabel><content src="${xhtmlFilename}"/></navPoint>`;
    }

    // 4. ARCHIVO TOC.NCX (CR√çTICO: Muchos lectores dicen "da√±ado" si esto falta)
    const ncxContent = `<?xml version="1.0" encoding="UTF-8"?>
<ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1">
  <head>
    <meta name="dtb:uid" content="${uniqueId}"/>
    <meta name="dtb:depth" content="1"/>
    <meta name="dtb:totalPageCount" content="${paginasData.length}"/>
    <meta name="dtb:maxPageNumber" content="${paginasData.length}"/>
  </head>
  <docTitle><text>Libro GracePrint</text></docTitle>
  <navMap>${ncxNavMap}</navMap>
</ncx>`;
    oebps.file("toc.ncx", ncxContent.trim());

    // 5. ARCHIVO CONTENT.OPF (El cerebro del libro)
    const opfContent = `<?xml version="1.0" encoding="UTF-8"?>
<package xmlns="http://www.idpf.org/2007/opf" unique-identifier="bookid" version="3.0">
  <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">
    <dc:identifier id="bookid">${uniqueId}</dc:identifier>
    <dc:title>Mi Cuento GracePrint</dc:title>
    <dc:language>es</dc:language>
    <dc:creator>GracePrint Studio</dc:creator>
    <meta property="dcterms:modified">${new Date().toISOString().split('.')[0]}Z</meta>
    <meta property="rendition:layout">pre-paginated</meta>
    <meta property="rendition:orientation">auto</meta>
    <meta property="rendition:spread">auto</meta>
  </metadata>
  <manifest>
    <item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>
    ${manifestItems}
  </manifest>
  <spine toc="ncx">
    ${spineItems}
  </spine>
</package>`;
    oebps.file("content.opf", opfContent.trim());

    // Generar ZIP final
    const content = await zip.generateAsync({type: "blob"});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(content);
    link.download = "Libro_GracePrint_Final.epub";
    link.click();
}
</script>
</body>
</html>
